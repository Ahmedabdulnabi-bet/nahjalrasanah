<!doctype html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Nahj Al-Rasanah | My RFQs</title>
    <link rel="icon" type="image/png" href="assets/images/logo-store.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body data-page="vendor-rfqs">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
                <img src="assets/images/logo-store.png" alt="Nahj Oil &amp; Gas Store" width="32" height="32" class="rounded-circle border border-secondary">
                <span class="fw-semibold">
                    Nahj Al-Rasanah<br>
                    <small class="text-muted" style="font-size:0.7rem;">My RFQs</small>
                </span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNavbar">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="index.html">Store</a></li>
                    <li class="nav-item"><a class="nav-link" href="vendor-dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="vendor-products.html">My Products</a></li>
                    <li class="nav-item"><a class="nav-link active" href="vendor-rfqs.html">My RFQs</a></li>
                </ul>
                <button id="logout-btn" class="btn btn-outline-light btn-sm ms-lg-3">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <main class="py-4">
        <div class="container">
            <h1 class="h3 fw-bold mb-4">RFQs for My Products</h1>
            
            <!-- Stats -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card border-primary">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Total RFQs</h6>
                            <h3 class="card-title mb-0 stats-number" id="total-rfqs">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-warning">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Pending</h6>
                            <h3 class="card-title mb-0 stats-number" id="pending-rfqs">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-info">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">This Month</h6>
                            <h3 class="card-title mb-0 stats-number" id="month-rfqs">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card border-success">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">Responded</h6>
                            <h3 class="card-title mb-0 stats-number" id="responded-rfqs">0</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- RFQs Table -->
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">All RFQs</h5>
                    <button class="btn btn-sm btn-outline-primary" id="refresh-btn">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Contact</th>
                                    <th>Products</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rfqs-table">
                                <tr id="loading-row">
                                    <td colspan="6" class="text-center py-5">
                                        <div class="spinner-border text-primary"></div>
                                        <p class="mt-2 text-muted">Loading RFQs...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="no-rfqs" class="text-center py-5 d-none">
                        <i class="bi bi-envelope display-4 text-muted"></i>
                        <p class="mt-3">No RFQs yet</p>
                        <p class="text-muted small">RFQs for your products will appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- RFQ Details Modal -->
    <div class="modal fade" id="rfqModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">RFQ Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="rfq-details">
                    <!-- Details will load here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="delete-rfq-btn">
                        <i class="bi bi-trash"></i> Delete RFQ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-light mt-5 pt-4 pb-3">
        <div class="container">
            <div class="row gy-3">
                <div class="col-md-6">
                    <h6 class="fw-semibold mb-2">Nahj Al-Rasanah Vendor Portal</h6>
                    <p class="small mb-0">View and manage RFQs for your products</p>
                </div>
                <div class="col-md-6 text-end">
                    <a href="vendor-dashboard.html" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
            <hr class="border-secondary my-3">
            <p class="small text-center mb-0">&copy; <span id="year"></span> Nahj Al-Rasanah LLC</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { firebaseConfig, COLLECTIONS } from './assets/js/firebase-config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            getDocs,
            deleteDoc,
            doc,
            query,
            where,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('RFQs page loaded');
            
            // Set copyright year
            const yearSpan = document.getElementById('year');
            if (yearSpan) {
                yearSpan.textContent = new Date().getFullYear();
            }
            
            // Global variables
            let auth, db;
            let currentUser = null;
            let vendorProducts = [];
            let vendorRfqs = [];
            let selectedRfqId = null;
            
            // Initialize Firebase
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log('‚úÖ RFQs Firebase initialized');
            } catch (error) {
                console.error('‚ùå Firebase init error:', error);
                showError('System initialization failed');
                return;
            }
            
            // Setup event listeners
            function setupEventListeners() {
                // Refresh button
                const refreshBtn = document.getElementById('refresh-btn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', loadVendorData);
                }
                
                // Logout button
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            await signOut(auth);
                            window.location.href = 'index.html';
                        } catch (error) {
                            console.error('Logout error:', error);
                        }
                    });
                }
                
                // Delete RFQ button
                const deleteBtn = document.getElementById('delete-rfq-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', deleteSelectedRfq);
                }
            }
            
            // Auth state listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log('User authenticated:', user.email);
                    currentUser = user;
                    setupEventListeners();
                    await loadVendorData();
                } else {
                    console.log('No user, redirecting...');
                    window.location.href = 'vendor-login.html';
                }
            });
            
            async function loadVendorData() {
                if (!currentUser) return;
                
                console.log('Loading vendor RFQs data...');
                showLoading(true);
                
                try {
                    // Load vendor's products
                    const productsSnapshot = await getDocs(
                        query(
                            collection(db, COLLECTIONS.PRODUCTS),
                            where('vendorId', '==', currentUser.uid)
                        )
                    );
                    
                    vendorProducts = [];
                    productsSnapshot.forEach(doc => {
                        vendorProducts.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    console.log('Vendor products:', vendorProducts.length);
                    
                    // Load all RFQs
                    const rfqsSnapshot = await getDocs(
                        query(
                            collection(db, COLLECTIONS.RFQS),
                            orderBy('createdAt', 'desc'),
                            limit(100)
                        )
                    );
                    
                    const allRfqs = [];
                    rfqsSnapshot.forEach(doc => {
                        allRfqs.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Filter RFQs that contain vendor's products
                    vendorRfqs = allRfqs.filter(rfq => {
                        if (!rfq.items || !Array.isArray(rfq.items)) return false;
                        
                        return rfq.items.some(item => 
                            vendorProducts.some(product => product.id === item.id)
                        );
                    });
                    
                    console.log('Vendor RFQs:', vendorRfqs.length);
                    
                    renderRfqsTable();
                    updateStats();
                    
                } catch (error) {
                    console.error('‚ùå Error loading vendor data:', error);
                    showMessage('Error loading data: ' + error.message, 'danger');
                } finally {
                    showLoading(false);
                }
            }
            
            function renderRfqsTable() {
                const rfqsTable = document.getElementById('rfqs-table');
                const noRfqsDiv = document.getElementById('no-rfqs');
                const loadingRow = document.getElementById('loading-row');
                
                if (!rfqsTable) return;
                
                // Hide loading row
                if (loadingRow) loadingRow.style.display = 'none';
                
                if (vendorRfqs.length === 0) {
                    rfqsTable.innerHTML = '';
                    if (noRfqsDiv) noRfqsDiv.classList.remove('d-none');
                    return;
                }
                
                if (noRfqsDiv) noRfqsDiv.classList.add('d-none');
                
                let html = '';
                vendorRfqs.forEach(rfq => {
                    // Get vendor's products from this RFQ
                    const vendorItems = rfq.items.filter(item => 
                        vendorProducts.some(product => product.id === item.id)
                    );
                    
                    const totalQty = vendorItems.reduce((sum, item) => sum + (item.qty || 1), 0);
                    const date = rfq.createdAt?.toDate ? 
                        rfq.createdAt.toDate().toLocaleDateString() : 'N/A';
                    
                    html += `
                        <tr>
                            <td>
                                <strong>${rfq.company || 'N/A'}</strong><br>
                                <small class="text-muted">${rfq.project || ''}</small>
                            </td>
                            <td>
                                ${rfq.contact || 'N/A'}<br>
                                <small class="text-muted">${rfq.email || ''}</small>
                            </td>
                            <td>
                                ${vendorItems.length} product(s)<br>
                                <small class="text-muted">${totalQty} units</small>
                            </td>
                            <td>${date}</td>
                            <td>
                                <span class="badge ${getStatusBadgeClass(rfq.status)}">
                                    ${rfq.status || 'pending'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-btn" data-id="${rfq.id}">
                                    <i class="bi bi-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                rfqsTable.innerHTML = html;
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        const rfqId = this.getAttribute('data-id');
                        viewRfqDetails(rfqId);
                    });
                });
            }
            
            function getStatusBadgeClass(status) {
                switch(status) {
                    case 'pending': return 'bg-warning';
                    case 'reviewed': return 'bg-info';
                    case 'responded': return 'bg-success';
                    case 'closed': return 'bg-secondary';
                    case 'cancelled': return 'bg-danger';
                    default: return 'bg-secondary';
                }
            }
            
            function updateStats() {
                const total = vendorRfqs.length;
                const pending = vendorRfqs.filter(r => r.status === 'pending').length;
                const responded = vendorRfqs.filter(r => r.status === 'responded' || r.status === 'closed').length;
                
                // Count this month's RFQs
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthCount = vendorRfqs.filter(rfq => {
                    if (!rfq.createdAt?.toDate) return false;
                    const rfqDate = rfq.createdAt.toDate();
                    return rfqDate >= firstDayOfMonth;
                }).length;
                
                // Update DOM
                document.getElementById('total-rfqs').textContent = total;
                document.getElementById('pending-rfqs').textContent = pending;
                document.getElementById('month-rfqs').textContent = monthCount;
                document.getElementById('responded-rfqs').textContent = responded;
            }
            
            function viewRfqDetails(rfqId) {
                const rfq = vendorRfqs.find(r => r.id === rfqId);
                if (!rfq) return;
                
                // Get vendor's products from this RFQ
                const vendorItems = rfq.items.filter(item => 
                    vendorProducts.some(product => product.id === item.id)
                );
                
                // Format date
                const date = rfq.createdAt?.toDate ? 
                    rfq.createdAt.toDate().toLocaleString() : 'N/A';
                
                // Build details HTML
                let detailsHtml = `
                    <h6>Company Information</h6>
                    <p><strong>Company:</strong> ${rfq.company || 'N/A'}</p>
                    <p><strong>Contact:</strong> ${rfq.contact || 'N/A'}</p>
                    <p><strong>Email:</strong> ${rfq.email || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${rfq.phone || 'N/A'}</p>
                    
                    <h6 class="mt-4">Project Details</h6>
                    <p><strong>Project:</strong> ${rfq.project || 'Not specified'}</p>
                    <p><strong>Delivery:</strong> ${rfq.delivery || 'Not specified'}</p>
                    <p><strong>Submitted:</strong> ${date}</p>
                    <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(rfq.status)}">${rfq.status || 'pending'}</span></p>
                    
                    <h6 class="mt-4">Requested Products (Your Products)</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Part No</th>
                                <th>Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                vendorItems.forEach(item => {
                    const product = vendorProducts.find(p => p.id === item.id) || {};
                    detailsHtml += `
                        <tr>
                            <td>${product.name || item.name || 'Unknown'}</td>
                            <td>${product.partNumber || item.partNumber || 'N/A'}</td>
                            <td>${item.qty || 1}</td>
                        </tr>
                    `;
                });
                
                detailsHtml += `
                        </tbody>
                    </table>
                `;
                
                if (rfq.notes) {
                    detailsHtml += `
                        <h6 class="mt-4">Additional Notes</h6>
                        <div class="bg-light p-3 rounded">
                            ${rfq.notes}
                        </div>
                    `;
                }
                
                // Set details content
                const detailsEl = document.getElementById('rfq-details');
                if (detailsEl) {
                    detailsEl.innerHTML = detailsHtml;
                }
                
                // Store RFQ ID for delete
                selectedRfqId = rfqId;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('rfqModal'));
                modal.show();
            }
            
            async function deleteSelectedRfq() {
                if (!selectedRfqId || !confirm('Are you sure you want to delete this RFQ?')) return;
                
                try {
                    // Delete from Firestore
                    await deleteDoc(doc(db, COLLECTIONS.RFQS, selectedRfqId));
                    
                    // Remove from local array
                    vendorRfqs = vendorRfqs.filter(r => r.id !== selectedRfqId);
                    
                    // Update UI
                    renderRfqsTable();
                    updateStats();
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('rfqModal'));
                    if (modal) modal.hide();
                    
                    showMessage('‚úÖ RFQ deleted successfully', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Error deleting RFQ:', error);
                    showMessage('Error deleting RFQ: ' + error.message, 'danger');
                }
            }
            
            function showLoading(show) {
                const refreshBtn = document.getElementById('refresh-btn');
                const loadingRow = document.getElementById('loading-row');
                
                if (refreshBtn) refreshBtn.disabled = show;
                if (loadingRow && show) loadingRow.style.display = 'table-row';
            }
            
            function showMessage(text, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                alertDiv.style.cssText = `
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    min-width: 300px;
                `;
                alertDiv.innerHTML = `
                    ${type === 'success' ? '‚úÖ' : '‚ùå'} ${text}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 3000);
            }
            
            function showError(message) {
                const container = document.querySelector('.container');
                if (container) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                    alertDiv.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    container.insertBefore(alertDiv, container.firstChild);
                }
            }
            
            console.log('üöÄ Vendor RFQs Page Initialized');
        });
    </script>
</body>
</html>